# Quick multi-node Kubernetes Cluster Getting Started

I have not created a blog entry in some time, and therefore this one might try to over compensate slightly with a fairly long technical entry.

In this entry I hope to demonstrate a couple of quick steps to get started with a Kubernetes cluster running on multiple nodes on a local development machine, ideal to quickly test applications and tools.

## Technologies and Stack

The stack consist of:

* [k3s](https://k3s.io/) Kubernetes distribution
* [multipass](https://multipass.run/) for creating multiple VM nodes quickly on a development machine running any Operating System
* A [Python Flask](https://flask.palletsprojects.com/en/2.1.x/) application, containerized with [Docker](https://www.docker.com/)

The following tools/application/utilities are assumed to be installed:

* [kubectl](https://kubernetes.io/docs/tasks/tools/#kubectl)
* Either [BASH](https://www.gnu.org/software/bash/) or [ZSH](https://www.zsh.org/) (examples will assume ZSH)
* Common GNU utilities such as `grep`, `awk` etc. For Windows users, using WSL2 is highly recommended
* A Git client, should you whish to clone the repositories referenced (recommended)

## System Requirements

The 3x Kubernetes nodes assume at least the following resources are available on the host system:

* 6x CPU cores (2x cores per VM)
* 8GB RAM allocated per VM (a system with 32GB RAM is recommended)

The settings can be adjusted with the minimum recommended spec for the host system:

* 4 CPU cores on your host system (1x core for each VM)
* 16 GB RAM (4GB allocated per VM)

# Deploying a K3s Cluster in Multipass in less than 5 minutes

Obtain the installation script from [my Gist](https://gist.githubusercontent.com/nicc777/0f620c9eb2958f58173224f29b23a2ff/raw/cb9ae7dd0e636057cfcc3ada57a07e74a41ce689/k3s-multipass.sh). I save these types of files on my system under a directory `~/opt/bin` (which is also in my path)

Based on your system configuration, you can adjust the Core and RAM allocation as follow:

In the 2nd line with the text `multipass launch -n $node -c 2 -m 4G` adjust the core count (`-c` parameter) and the memory allocation (`-m` parameter) as required.

Once done, simply run:

```shell
~/opt/bin/k3s-multipass.sh
```

Once all is deployed, the VM's can be listed with the command `multipass list`

# Configuring Kubectl

The Kubernetes client configuration will be stored in the file `~/k3s.yaml`

Set this as your default with the following command:

```shell
export KUBECONFIG=/home/nicc777/k3s.yaml
```

And quickly check your installation with te command `kubectl get nodes` which should give output similar to the following:

```text
NAME    STATUS   ROLES                  AGE   VERSION
node2   Ready    <none>                 8h    v1.22.7+k3s1
node3   Ready    <none>                 8h    v1.22.7+k3s1
node1   Ready    control-plane,master   8h    v1.22.7+k3s1
```

# The Demo Application

The demo application repository is at https://github.com/nicc777/pyk8sdemo-app

You can clone this repository and explore, but the application is already containerized and [available in Docker Hub](https://hub.docker.com/r/nicc777/demo-flask-app)

This particular container includes some additional tools which can be very useful for troubleshooting and testing.

If you follow these instructions practically, you would need the following files:

```
.
├── kubernetes_manifests
│   ├── troubleshooting-app-pod-only.yaml
│   └── troubleshooting-app.yaml
```

These files point to the pre-existing image in Docker Hub, but you can change it to suite your needs.

# Kubernetes Deployments

## Preparation - Create a Namespace

TODO

## Simple Deployment - Pod Only

TODO

## Deployment with Ingress

TODO

# Quick review / Summary

TODO

# References

Below is the CTO of [civo](https://www.civo.com/) explaining what K3s and how it relates to Kubernetes. Civo is a [Cloud Native](https://www.cncf.io/) service provider but I am not sponsored or supported by them - This is merely a really short and very good explanation of what K3s is. I do have a Civo account and I have used them in a personal capacity, but this is not at all required to follow any of the steps in this blog to get K3s up and running on your own system.

<iframe width="560" height="315" src="https://www.youtube.com/embed/FmLna7tHDRc" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<div id="disqus_thread"></div>
<script>
    /**
    *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://nicc777.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


