# Event Driven Operations - An Example in AWS

A lot has been written about Event Driven Architecture and it is hard to point to a single great resource. Therefore, to save space on my blog (and preventing it from becoming a book), I will just share the following resources for those who would like to familiarize themselves with the concept and theory:

* [What do you mean by “Event-Driven”?](https://martinfowler.com/articles/201701-event-driven.html) by Martin Fowler (2017-02-07)
* [Wikipedia: Event-driven architecture](https://en.wikipedia.org/wiki/Event-driven_architecture) by various authors ([edit history](https://en.wikipedia.org/w/index.php?title=Event-driven_architecture&action=history))
* Various industry takes on the subject:
  * [Red Hat](https://aws.amazon.com/event-driven-architecture/)
  * [AWS](https://www.redhat.com/en/topics/integration/what-is-event-driven-architecture) 
  * [MS Azure](https://docs.microsoft.com/en-us/azure/architecture/guide/architecture-styles/event-driven)
  * [Tibco](https://www.tibco.com/reference-center/what-is-event-driven-architecture)
* [Reference Architecture Pattern](https://microservices.io/patterns/data/event-driven-architecture.html) which also notes that, at least from their perspective, it has been replaced by the [Saga Pattern](https://microservices.io/patterns/data/saga.html)

As you will see, virtually all the resources focus on this pattern from an application perspective. RedHat and AWS hints toward an operational context, but overall I found very little solid references that focus on operational contexts for those of us who have to manage infrastructure, cloud platforms etc.

As we move toward [Infrastructure as Code](https://www.redhat.com/en/topics/automation/what-is-infrastructure-as-code-iac) I think it is worthwhile for DevOps and SRE engineers to also better understand the concept of event driven architecture and patterns, as we also are starting to produce more and more code (and logic). By the way, I specifically link to the Red Hat resource here, as I believe they have a really short but accurate description of the two dominant types of IaC at the moment: declarative and imperative.

What I want to explore in this post is an example of how anyone that has to look after the operations of a platform can leverage the event driven pattern in their operational model. I will focus on AWS, as this is where my experience currently lies - but the principles can very well be applied in any environment.

# Example Scenario

For this specific blog post, I am not too concerned about IaC - I assume it is something that you already do - at least to some extend. If you are not yet on the IaC boat, I would suggest you learn about it as it will change your life! However, your environment, choice of tools etc. will largely dictate if you lean toward a declarative or an imperative IaC strategy. It could even be both! However, since I will be focusing on AWS and use [SAM](https://aws.amazon.com/serverless/sam/) for the examples, you have to keep in mind that this approach is, in my opinion, a little bit of a mix between the two. AWS themselves [will define CloudFormation as declarative](https://docs.aws.amazon.com/whitepapers/latest/introduction-devops-aws/infrastructure-as-code.html) while tools like SAM leans more toward the definition of imperative - even though the final output is CloudFormation templates.

So, without going to deep into these differences any further, I will look at AWS as an example and focus on how we can know that something we defined as IaC changes state - for whatever reason. The idea will be to send a properly formatted notification - standardized to our own specification, to something that can collate all this data. I am not going to propose a solution for how this is finally collected - there are many options and each organization have their own mix. However, the concept and examples up to that point should be fairly portable for AWS users.

In AWS we deploy virtual infrastructure as a service. AWS has hundreds of services, like EC2 (virtual machines), ELB (Application and Network Load Balancers) etc. During a deployment, resources will be created. For example, in the EC2 service, resources like virtual machines, block storage devices, network interfaces etc. are created and all of these resources are required for the resource to work properly.

From a service perspective, each of the resource types in the services can be in different states at different times and in general there are states for a resource being provisioned, then one for it being in a running and stable state and finally a state for when a resource is being de-provisioned (stopped, deleted or whatever other terminology is fitting).

In AWS, when resources changes state, many of such services that the resources belong to can emit an event. This event can be handled by another AWS Service known as the [AWS EventBridge](https://aws.amazon.com/eventbridge/). You will see from the service description that the service is really pitched once again at application solutions. However, if you look at the conceptual diagram (copy below), you will clearly see `AWS Services` as an event source:

![AWS EventBridge from DrawIO](../../images/blog_2022_07_31/aws_event_bridge_drawio.png)

The AWS EVentBridge can get very involved, but from our perspective we are only interested when a resource in AWS changes state. We want to get informed about it and be able to react to it.

In my example, I will demonstrate how we can get the basic pieces put together to capture AWS service events, transform the even message to a standard form and finally deliver that standardized message in a way that can be consumed by virtually any other third party application.

At this point, it is also important to know which services and resources is capable of producing events. A list of supported services is available [in the AWS documentation for EventBridge](https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/EventTypes.html). As can be seen in the diagram above, AWS service events are directed to the default event bus.

In the example scenario we will look at [the EC2 service](https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/EventTypes.html#ec2_event_type) and we see for this service, the following states will produce events:

* `running`
* `shutting-down`
* `stopped`
* `stopping`
* `terminated`

Some of these states are transition states or temporary. In a transition state, the service may sometimes appear to be still operating normally. This depends a lot on the actual service and how it is configured. For example, an EC2 instance in the `shutting-down` state may still have a working SSH service and if you time it right, you may even still be able to log into the instance while in this transitioning state - however short lived your session may be!

ALso in this example, I want to demonstrate how we can use resource tagging to further fine tune and manipulate our event handling. In this example, I want to show how we can exclude certain EC2 state change events from propagating by using a resource tag called `IgnoreEventBridgeEvents` with any value set (the tag must just be present). We can use this perhaps for a resource we just use temporarily which is not critical for our business operations - maybe just to test something out quickly.

Therefore, any EC2 event, where the EC2 instance in question has a tag named `IgnoreEventBridgeEvents` present, will be ignored by our event processing.

# Solution Design

TODO

* AWS Service involved
* Leveraging SNS Fan Out to SQS
* Our hypothetical Organizational Resource EVent Handler...
* Note about [AWS SAM templates](https://github.com/aws-samples/serverless-patterns)

# Implementation

AWS have a fairly large collection of [example SAM templates](https://github.com/aws-samples/serverless-patterns) in their `serverless patterns` repository. I used these to get started quickly with [my own example repository](https://github.com/nicc777/aws-event-messaging-example) for this exercise.

The specific examples I used included the following:

* [eventbridge-sns](https://github.com/aws-samples/serverless-patterns/tree/main/eventbridge-sns) example
* [sns-sqs](https://github.com/aws-samples/serverless-patterns/tree/main/sns-sqs) example
* [sqs-lambda](https://github.com/aws-samples/serverless-patterns/tree/main/sqs-lambda) example
* [lambda-sns-lambda](https://github.com/aws-samples/serverless-patterns/tree/main/lambda-sns-lambda-sam-java) example
* [lambda-ses](https://github.com/aws-samples/serverless-patterns/tree/main/lambda-ses) example

TODO

* GitHub Project
* Deployment notes

# Testing

TODO

Scenarios:

* Creating an instance 
* Stopping an EC2 Instance
* Restart the instance
* Create an instance tagged to be ignored
* Terminating all our instances

# Discussion

TODO

* Keeping a record of events...
* Event timing
* Scheduled events

# Wrapping up and conclusion

TODO

# Tags

infrastructure, iac, event driven, patterns, architecture, aws, azure, redhat, cloud, support, devops, sre

<div id="disqus_thread"></div>
<script>
    /**
    *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://nicc777.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
